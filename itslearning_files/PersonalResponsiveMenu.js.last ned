function PersonalResponsiveMenuInit(l){function f(a){jQuery.ajax({type:"GET",url:t.personalMessageSourceUrl,success:function(b){D=b;J=new Date;e.updateMessageCounterBasedOnCookie();a&&n(b)},error:CommonFunctions.alertAjaxError})}function n(b){a.messageDialogContent.empty().html(b);b=-(a.inboxMenuLink.width()/2+ +a.inboxMenuLink.css("padding-right").replace("px","")+ +a.inboxMenuLink.css("border-right-width").replace("px","")+ +a.inboxMenuLink.css("margin-right").replace("px",""));var d=-(a.inboxMenuLink.height()/
2+ +a.inboxMenuLink.css("padding-bottom").replace("px","")+ +a.inboxMenuLink.css("border-bottom-width").replace("px","")+ +a.inboxMenuLink.css("margin-bottom").replace("px",""));m.openDialogAt(b,d,!0);c.isAndroidBrowser||u();v(a.inboxMenuLink.closest("li"),!0);M();N();O()}function A(){K&&clearTimeout(K);K=setTimeout(u,200)}function u(){var b=a.messageDialogContent,d=w.height()-b.offset().top-(b.outerHeight(!0)-b.height());b.css({"max-height":0>d?0:d,"overflow-y":"auto"})}function q(){return{width:400,
setFocus:!1,marginTop:38,marginBottom:0,noTitle:!0,showArrow:!0,align:"center",valign:"bottom",cssClass:E.popupContainer,customScripts:{beforeCloseDialog:null}}}function g(b){k=P(b,a.notificationLink,a.notificationDialogContent);k.setBeforeCloseDialog(function(){v(a.notificationLink.closest("li"),!!a.notificationsBadge.text())});k.hideHeader();k.hideFooter();k.toggleCloseLink(!1)}function S(b){m=P(b,a.inboxMenuLink,a.messageDialogContent);m.setBeforeCloseDialog(function(){v(a.inboxMenuLink.closest("li"),
!!a.messagesBadge.text())});m.hideHeader();m.hideFooter();m.toggleCloseLink(!1)}function P(a,d,c){a.toggleElement=d;return new ContextDialog(c,a)}function T(){if(k.isOpened()){var b=a.notificationDialogContent.find("li."+E.unreadNotificationItem);0<b.length&&CCL.CommonFunctions.safeAjaxPost({url:t.updateReadNotifications,data:{notifications:U(b).join()}});b=parseInt(jQuery("#"+a.unreadNotificationsCountHiddenId).val());F(b,0<b||k.isOpened())}}function V(){CCL.CommonFunctions.safeAjaxPost({url:t.markAllNotificationsAsSeen});
F(0,!1)}function U(a){return a.map(function(a,b){return jQuery(b).data("id")}).toArray()}function F(b,d){h(b,a.notificationLink,a.notificationsBadge,!!d)}function h(a,d,c,e){v(d.closest("li"),e);c.text(B(a,!0));c.toggle(0<a)}function v(a,d){a.toggleClass(E.opaque,d)}function N(){a.messageDialogContent.find("#"+c.messageCounterIds.internalMessagesCounter).text(G(B(r)))}function M(){if(!window.itslearning.settings.app.is_instant_message_system_enabled){var b=c.primaryCloudEmailType===CloudEmailType.office365?
G(B(x,!1)):G(B(y,!1));a.messageDialogContent.find("#"+c.messageCounterIds.cloudMessagesCounter).text(b)}}function O(){a.messageDialogContent.find("#"+c.messageCounterIds.skoleIntraMessagesCounter).text(G(B(C,!1)))}function B(a,d){return void 0===a||0>=a?"":d&&100<=a?"99+":a}function G(a){return""===a?"":" ("+a+")"}function W(a,d,c,e){var b=a?"touchstart":"click",g=c.find("li:first-child > button");c.find("a").click(function(){c.hide();e&&e()});d.on(b+" keydown",function(a){if(a.type===b||a.which===
CCL.CommonConstants.keyCodes.arrowDown)"false"===$(".c-messages-popup").attr("aria-hidden")&&$(".c-messages__overlay").click(),c.toggle(),g.focus()});$(document).on(b+" "+CCL.CommonTriggers.clickInInnerFrame,function(a){if(c.is(":visible")){a=a.target;var b=$(a),Q=a===d.get(0)||1===b.closest(d).length;b=!Q&&(a===c.get(0)||1===b.closest(c).length);var f=c.find("li:last-child > a");Q||b||(c.hide(),window.FreshdeskChat&&window.FreshdeskChat.destroy(),e&&e());f.keydown(a,function(a){a.which!==CCL.CommonConstants.keyCodes.tab||
a.shiftKey||(a.preventDefault(),g.focus())});g.keydown(a,function(a){a.shiftKey&&a.which===CCL.CommonConstants.keyCodes.tab&&(a.preventDefault(),f.focus())})}});c.keydown(function(a){a.which===CCL.CommonConstants.keyCodes.escape&&($(c).hide(),e&&e(),d.focus())})}window[l]=this;var e=this,w=jQuery(window),a,c,t,E,z,k,m,K,L=0,p=0,x=0,y=0,r=0,R,D,H=0,J,I,C=0;e.initialize=function(){a=e.controls;c=e.settings;t=e.settings.urls;E=e.settings.cssClasses;z=e.settings.queryStringParameters;I=e.toggleMenuLinkFunction;
a.personalMenuLink.on("click",function(){"false"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")&&jQuery(InstantMessageSelectors.overlaySelector).click();I()});var b=document.querySelector("button[name=closePersonalMenu]");b&&b.addEventListener("click",function(){a.personalMenuDropDown.hide();I();a.personalMenuLink.focus()});W(c.isIos,a.personalMenuLink,a.personalMenuDropDown,I);a.searchBoxMobile.on("click touchstart touchend",function(a){a.stopPropagation()});a.searchBox.add(a.searchBoxMobile).on(c.searchTextEvent,
function(a,b){top.location.href=t.searchMainPageNavigateUrl.replace(c.searchPlaceholder,encodeURIComponent(encodeURIComponent(b)))});a.notificationLink.click(function(b){if(k.isOpened())k.closeDialog(),a.notificationLink.attr("aria-expanded",!1);else{jQuery(InstantMessageSelectors.overlaySelector).click();var d=-(a.notificationLink.width()/2+ +a.notificationLink.css("padding-right").replace("px","")+ +a.notificationLink.css("border-right-width").replace("px","")+ +a.notificationLink.css("margin-right").replace("px",
"")),e=-(a.notificationLink.height()/2+ +a.notificationLink.css("padding-bottom").replace("px","")+ +a.notificationLink.css("border-bottom-width").replace("px","")+ +a.notificationLink.css("margin-bottom").replace("px",""));if(c.hasSkoleIntraNotifications&&""!==c.skoleIntraNotificationsBellUrl){var g=$(a.notificationDialogContent),f=g.find(".c-spinner-bounce"),h=g.find("iframe");g.removeClass(c.notificationsLoadedClass);h.attr("src",c.skoleIntraNotificationsBellUrl);$(h).on("load",function(){f.hide();
g.addClass(c.notificationsLoadedClass);setTimeout(V,500);h.show()});h.hide();f.show();k.openDialogAt(d,e,!0);v(a.notificationLink.closest("li"),!0);a.notificationLink.attr("aria-expanded",!0)}else jQuery.ajax({type:"GET",url:t.personalNotificationSourceUrl,success:function(b){a.notificationDialogContent.html(b);k.openDialogAt(d,e,!0);v(a.notificationLink.closest("li"),!0);setTimeout(T,3E3);$helpButton=a.notificationDialogContent.find("a").first();$emptyMessage=a.notificationDialogContent.find(".itsl-notifications-popup-empty-message");
(isEmpty=0<$emptyMessage.length)?($helpButton.keydown(function(a){a.keyCode==CCL.CommonConstants.keyCodes.tab&&a.shiftKey&&(a.preventDefault(),$emptyMessage.focus())}),$emptyMessage.keydown(function(a){a.keyCode!=CCL.CommonConstants.keyCodes.tab||a.shiftKey||(a.preventDefault(),$helpButton.focus())})):($showAllLink=a.notificationDialogContent.find(".itsl-notifications-popup-footer-box > a"),$helpButton.keydown(function(a){a.keyCode==CCL.CommonConstants.keyCodes.tab&&a.shiftKey&&(a.preventDefault(),
$showAllLink.focus())}),$showAllLink.keydown(function(a){a.keyCode!=CCL.CommonConstants.keyCodes.tab||a.shiftKey||(a.preventDefault(),$helpButton.focus())}));$helpButton.focus();a.notificationLink.attr("aria-expanded",!0);$(".ccl-notification-popup").keydown(function(b){b.keyCode==CCL.CommonConstants.keyCodes.escape&&a.notificationLink.attr("aria-expanded",!1)})},error:CommonFunctions.alertAjaxError})}});c.shouldOpenMessagesPopUp&&(a.inboxMenuLink.click(function(a){m.isOpened()?m.closeDialog():((a=
!D)||(a=J?18E4<(new Date).getTime()-J.getTime():!1),a?f(!0):n(D))}),c.isAndroidBrowser||w.resize(A),w.on("load",function(){f()}));F(0,!1);h(0,a.office365CloudEmailIconLink,a.office365CloudEmailBadge,!1);h(0,a.gmailCloudEmailIconLink,a.gmailCloudEmailBadge,!1);h(0,a.inboxMenuLink,a.messagesBadge,!1);h(0,a.emailMenuLink,a.emailBadge,!1);h(0,a.skoleIntraMessagesIconLink,a.skoleIntraMessagesBadge,!1);CommonFunctions.attachPostMessageEventListener(w,CommonWindowMessages.MessageNames.unreadNotificationCounterChanged,
function(a){F(a.extendedData,0<a.extendedData||k.isOpened())});CommonFunctions.attachPostMessageEventListener(w,CommonWindowMessages.MessageNames.unreadMessagesCounterChanged,function(b){CCL.CommonFunctions.safeAjaxPost({url:e.settings.urls.updateNumberOfUnreadMessagesUrl}).done(function(b){c.hasSkoleIntraMessages&&h(b,a.skoleIntraMessagesIconLink,a.skoleIntraMessagesBadge,!1)}).fail(CommonFunctions.alertAjaxError)});CommonFunctions.attachPostMessageEventListener(w,CommonWindowMessages.MessageNames.openGroupChat,
function(a){"true"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")&&"function"===typeof window.InstantMessageOpenWindowForCollaboration&&window.InstantMessageOpenWindowForCollaboration(a.collaborationId,function(){jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false");jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden")})});g(q());c.shouldOpenMessagesPopUp&&S(q());c.hasInternalMessages&&(R=new RegExp("[\\?&]"+c.onlineInfoCookie.unreadMessagesKey+
"=([^&#]*)"));c.hasEmail&&(numberOfUnreadEmailCookieRegex=new RegExp("[\\?&]"+c.onlineInfoCookie.unreadEmailKey+"=([^&#]*)"))};e.setUnreadInternalMessages=function(a){c.hasInternalMessages&&a!==p&&(p=a,N())};e.setUnreadEmailMessages=function(a,d){c.hasEmail&&a!==r&&(r=a,H=d)};e.setUnreadCloudEmailMessages=function(a,d){!c.hasCloudEmail||x===a&&y===d||(x=a,y=d,M())};e.setUnreadSkoleIntraMessages=function(a){c.hasSkoleIntraMessages&&C!==a&&(C=a,O())};e.updateMessageCounterBasedOnCookie=function(){if(c.hasInternalMessages){var a=
R.exec(jQuery.cookie(c.onlineInfoCookie.name));a&&a.length&&(p=parseInt(a[1]),e.setCounts())}};e.setCounts=function(){L&&p!==L&&e.invalidateCache();if(H&&0<H&&window.itslearning.settings.app.is_instant_message_system_enabled){var b=e.controls.emailMenuLink.attr("href"),d=b.getQueryStringParameter(z.textURL);d=d.setQueryStringParameter(z.emailAccountsRedirect,"False");d=d.setQueryStringParameter(z.emailRedirect,"True");d=d.setQueryStringParameter(z.accountID,H);e.controls.emailMenuLink.attr("href",
b.setQueryStringParameter(z.textURL,d))}L=p;b=0;0<p&&(c.hasInternalMessages||c.hasEmail)&&(b+=p,window.itslearning.settings.app.is_instant_message_system_enabled&&(window.itslearning.instantmessaging.unreadInternalMessages=p));(0<x||0<y)&&c.hasCloudEmail&&(window.itslearning.settings.app.is_instant_message_system_enabled?(h(x,a.office365CloudEmailIconLink,a.office365CloudEmailBadge,!1),h(y,a.gmailCloudEmailIconLink,a.gmailCloudEmailBadge,!1)):b=c.primaryCloudEmailType===CloudEmailType.office365?b+
x:b+y);0<C&&c.hasSkoleIntraMessages&&h(C,a.skoleIntraMessagesIconLink,a.skoleIntraMessagesBadge,!1);!window.itslearning.settings.app.is_instant_message_system_enabled&&c.hasEmail&&(b+=r);0<r&&c.hasEmail&&h(r,a.emailMenuLink,a.emailBadge,!!(0<r));if(c.hasInternalMessages||c.hasCloudEmail||c.hasEmail)d=0<b||e.settings.shouldOpenMessagesPopUp&&m.isOpened(),h(b,a.inboxMenuLink,a.messagesBadge,!!d);CommonFunctions.makePostMessageCall(window.top,new CommonWindowMessages.GenericMessageWithData(CommonWindowMessages.MessageNames.unreadNotificationCounterChanged,
e.unreadNotifications));window.itslearning.settings.app.is_instant_message_system_enabled&&(b=jQuery.Event("UpdateUnreadMessagesCount"),jQuery(window).trigger(b))};e.invalidateCache=function(){D=void 0};return e}
var CloudEmailType={office365:"Office365",gmail:"Gmail"},InstantMessageSelectors={largeHeaderLogo:".l-logo",mainMenuSelector:"ul.l-main-menu-items",overlayClass:"c-messages__overlay",overlaySelector:".c-messages__overlay",overlayLargeSelector:"c-messages__overlay--largeHeader",overlayBlackClass:"c-messages__overlay--black",popupSelector:".c-messages-popup",popupIconSelector:".l-personal-menu-instantmessage",popupIconSelectedClass:"l-personal-menu-icon-instantmessage-selected"};
function FlyOutPopupInit(l){jQuery("body").append('<div class="'+InstantMessageSelectors.overlayClass+' is-hidden"></div>');0<jQuery(InstantMessageSelectors.largeHeaderLogo).length&&jQuery(InstantMessageSelectors.overlaySelector).addClass(InstantMessageSelectors.overlayLargeSelector);jQuery(InstantMessageSelectors.popupSelector).load(l);jQuery(InstantMessageSelectors.popupIconSelector).on("click",function(){var f=jQuery(this);"true"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")?
(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),jQuery(InstantMessageSelectors.mainMenuSelector).on("click",function(f){jQuery(InstantMessageSelectors.mainMenuSelector).off("click");"false"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")&&jQuery(InstantMessageSelectors.overlaySelector).click()}),"undefined"!==typeof window.InstantMessageOpenWindow&&window.InstantMessageOpenWindow()):
jQuery(InstantMessageSelectors.overlaySelector).click();jQuery(f).closest("li").toggleClass(InstantMessageSelectors.popupIconSelectedClass)});jQuery(InstantMessageSelectors.overlaySelector).on("click",function(f){f=jQuery(f.target);if(f.hasClass(InstantMessageSelectors.overlayClass)||f.hasClass(InstantMessageSelectors.overlayBlackClass))jQuery(this).closest("li").toggleClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass(InstantMessageSelectors.overlayBlackClass),
jQuery(InstantMessageSelectors.overlaySelector).addClass("is-hidden"),jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","true"),"undefined"!==typeof window.InstantMessageCloseWindow&&window.InstantMessageCloseWindow()})}
function OpenInstantMessageSendNew(l){"undefined"!==typeof window.showInstantMessageSendNew&&(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.popupIconSelector).closest("li").addClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),window.showInstantMessageSendNew(l))}
function OpenInstantMessageModal(){"undefined"!==typeof window.InstantMessageOpenModalWindow?openInstentMessageModalWindow():window.setTimeout(openInstentMessageModalWindow,3E3)}
function openInstentMessageModalWindow(){"undefined"!==typeof window.InstantMessageOpenModalWindow&&(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.popupIconSelector).closest("li").addClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),window.InstantMessageOpenModalWindow())}
jQuery(function(){if(window.itslearning.settings.app.is_instant_message_system_enabled){var l=function(g){g?10>=A&&(A+=1,window.clearInterval(u),u=window.setInterval(f,3E4)):(window.clearInterval(u),A=0)},f=function(){jQuery.connection.hub.start().done(function(){var g="";localStorage.getItem("instantmessage-channelid")&&(g=localStorage.getItem("instantmessage-channelid"));var f="/restapi/personal/instantmessages/communicationchannel/{channelId}/v1".replace("{channelId}",jQuery.connection.hub.id);
5<g.length&&(f=f+"?unregister="+g);g={};g[itslearning.settings.antiForgeryHeaderName]=itslearning.settings.antiForgeryHeaderValue;CCL.CommonFunctions.safeAjaxPost({url:f,headers:g}).done(function(){n(!0);l(!1);console.log("SignalR connection registered. ChannelId: "+jQuery.connection.hub.id)});localStorage.setItem("instantmessage-channelid",jQuery.connection.hub.id)}).fail(function(g){n(!1);l(!0);console.log("Error starting SignalR connection: "+g)})},n=function(g){var f=jQuery.Event("SignalRConnectionStatus");
jQuery(window).trigger(f,g)},A=0,u;jQuery.connection.hub.url=window.itslearning.settings.app.signal_r_endpoint;var q=jQuery.connection.instantMessageHub;"undefined"!==typeof q&&null!==q&&(q.client.alertNewMessage=function(g){g=JSON.parse(g);var f=jQuery.Event("NewSignalRInstantMessage");jQuery(window).trigger(f,g)},q.client.alertThreadDeleted=function(g){var f=jQuery.Event("SignalRThreadDeleted");jQuery(window).trigger(f,g)});f();jQuery.connection.hub.connectionSlow(function(){console.log("We are currently experiencing difficulties with the connection.")});
jQuery.connection.hub.reconnecting(function(){n(!1);console.log("SignalR connection reconnecting.")});jQuery.connection.hub.disconnected(function(){n(!1);console.log("SignalR connection disconnected.");l(!0)});jQuery.connection.hub.reconnected(function(){n(!0);console.log("SignalR connection reconnected.");l(!1)})}});

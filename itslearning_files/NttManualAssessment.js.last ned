function NttManualAssessment(){window.NttManualAssessment=this;this.name="NttManualAssessment";this.firstLoad=function(){var a=this,b=new CCL.CallbackDebouncer(function(b){b=$(b);a.onInputValueChanged(b);a.saveAnswersAndUpdateScore(!0)});a.controls.table.find("input[type='number'][id*='InputFor_QuestionResultId']").on("focusout paste change blur input propertychange",function(){b.invokeCallback(this,100)});a.controls.buttons.find("input."+a.settings.cssClassess.okButtons+", button."+a.settings.cssClassess.okButtons).on("click",
function(){a.controls.table.find("input[type='number'][id*='InputFor_QuestionResultId']").each(function(){a.onInputValueChanged($(this))});a.saveAnswersAndUpdateScore(!1);return!0});a.settings.answers=[];a.getAnswersFromSession().done(function(b){$.each(b?b:[],function(b,c){b=a.controls.table.find("input[type='number'][id$='InputFor_QuestionResultId"+c.questionResultId+"']");0!==b.length&&(b.val(c.rawValue),a.onInputValueChanged(b),$(b).removeClass(a.settings.cssClassess.emptyInputValue),c.isValid||
a.IsValueValid(b.get(0)))});a.updateScoreValue();a.saveAnswersAndUpdateScore(!1)})};this.onInputValueChanged=function(a){var b=a.get(0),d=this.IsValueValid(b);b=this.getQuestionResultIdFromInput(b);this.insertOrUpdateRawValue(b,a,d)};this.getAnswersData=function(){return JSON.stringify({answers:this.settings.answers})};this.saveAnswersAndUpdateScore=function(a){this.updateScoreValue();return this.saveAnswersToHidden()&&a?this.saveAnswersToSession():$.Deferred().resolve()};this.saveAnswersToHidden=
function(){var a=this.getAnswersData(),b=this.controls.manualAssessmentsHidden.val();this.controls.manualAssessmentsHidden.val(a);return a!==b};this.updateScoreValue=function(){var a=this,b=0,d=0;$.each(a.settings.answers,function(e,c){c.isValid&&(b+=a.getInvariantValueFromUi(c.rawValue),d+=a.getInvariantValueFromUi(c.initRawValue))});b+=parseFloat(a.settings.actualTotalScore-d);a.showScoreValue(b)};this.showScoreValue=function(a){this.controls.resultField.html(this.settings.pointsFormatString.replace("%f",
this.getUiValueFromInvariant(a.toFixed(2))))};this.getQuestionResultIdFromInput=function(a){return JSON.parse(a.nextSibling.value).questionResultId};this.getQuestinMaxPoints=function(a){return parseFloat(JSON.parse(a.nextSibling.value).maxQuestionPoints)};this.insertOrUpdateRawValue=function(a,b,d){var e=null,c=this.getInvariantString(b.val()).toString();b=b.get(0).defaultValue;$.each(this.settings.answers,function(b,c){if(c.questionResultId===a)return e=c,!1});null==e?(e={questionResultId:a,testResultId:this.settings.testResultId,
rawValue:isNaN(c)||0===this.trim(c).length?b:c,isValid:d,initRawValue:b},this.settings.answers.push(e)):(!isNaN(c)&&0<this.trim(c).length&&(e.rawValue=c),e.isValid=d,e.testResultId=this.settings.testResultId)};this.getInvariantValueFromUi=function(a){return a&&a.length&&(a=parseFloat(a.replace(/,/g,".").replace(/\+/,"")),!isNaN(a))?a:0};this.getUiValueFromInvariant=function(a){return a?a.toString().replace(".",this.settings.decimalSeparator):"0"};this.saveAnswersToSession=function(){return CCL.CommonFunctions.safeAjaxPost({url:this.settings.webMethods.saveManualAssessments,
data:{answers:this.settings.answers}})};this.getAnswersFromSession=function(){return $.getJSON(this.settings.webMethods.getManualAssessments.replace("{testResultId}",this.settings.testResultId))};this.trim=function(a){return a.toString().replace(/(^\s+)|(\s+$)/g,"")};this.getInvariantString=function(a){return a&&a.length?a.replace(/,/g,".").replace(/\+/,""):""};this.IsValueValid=function(a){var b=!0;if(!a||""===$(a).val())return!0;if($(a).val()){var d=void 0;a.parentNode&&1<a.parentNode.childNodes.length&&
(d=this.getQuestinMaxPoints(a));if(a.value&&d){var e=this.GetInvariantValueFromUI(a.value),c=parseFloat(e),f=this.settings.negativeScore?-1:0;if(!this.ValidateIntValue(e)||c<f*d||c>d)b=!1}}else b=!1;(d=this.controls.table.find("span[id$='ValidationMessageFor_QuestionResultId"+this.getQuestionResultIdFromInput(a)+"']"))&&(b?d.removeClass(this.settings.cssClassess.validationMessage).addClass("h-hidden"):d.removeClass("h-hidden").addClass(this.settings.cssClassess.validationMessage));b?$(a).removeClass(this.settings.cssClassess.invalidInputValue):
$(a).addClass(this.settings.cssClassess.invalidInputValue);return b};this.ValidateIntValue=function(a){var b=/^-?\d*?\.?\d*$/;return 0===a.length||a.match(b)};this.GetInvariantValueFromUI=function(a){var b=void 0;a&&(b=a.replace(/,/g,"."),b=b.replace("/"+this.settings.specialChars+"/",""));return b}};
